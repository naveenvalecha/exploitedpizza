<?php

/**
 * @file
 * Admin page callback file for the pizza module.
 */

/**
 * Page callback: Generates the appropriate node with pizza listing.
 *
 * @return string
 *   A renderable form array for the respective request.
 */
function pizza_node_listing() {
  $header = array(
    array('data' => t('Nid'), 'field' => 'nid', 'sort' => 'asc'),
    array('data' => t('Node Title'), 'field' => 'title'),
    array('data' => t('Delete'), 'field' => 'delete'),
    array('data' => t('Confirm Delete'), 'field' => 'confirmdelete'),
  );
  $rows = array();
  $query = db_select('node', 'n')
    ->fields('n', array('nid', 'type', 'title'))
    ->condition('type', 'pizza', '=')
    ->condition('n.status', NODE_PUBLISHED);
  $query->addTag('node_access');
  $table_sort = $query->extend('TableSort')
    ->orderByHeader($header);
  $pager = $table_sort->extend('PagerDefault')
    ->limit(10);
  $results = $pager->execute();
  foreach ($results as $row) {
    $title = $row->title;
    $rows[] = array(
      $row->nid,
      // $row->title,
      check_plain($row->title),
      l(t('delete'), 'admin/pizza/' . $row->nid . '/delete'),
      l(t('delete'), 'admin/pizza/delete/' . $row->nid, array('query' => array('destination' => 'admin/pizza'))),
    );
  }
  return theme('table', array(
    'header' => $header,
    'rows' => $rows)) . theme('pager');
}

/**
 * Function to delete pizza node.
 */
function pizza_delete() {
  $nid = arg(2);
  node_delete($nid);
  cache_clear_all();
  drupal_set_message(t('Pizza Deleted.'), 'status', FALSE);
  drupal_goto($_GET['target']);
  if (!url_is_external($_GET['target'])) {
    drupal_goto($_GET['target']);
  }
}

/**
 * Function to confirm delete action on pizza node.
 */
function pizza_delete_confirm($form, &$form_state, $nid) {
  $form['nid'] = array(
    '#type' => 'value',
    '#value' => $nid,
  );
  return confirm_form($form,
    t('Are you sure you want to delete this pizza node?'), 'admin/pizza',
    t('This action cannot be undone.'),
    t('Delete'),
    t('Cancel')
  );
}

/**
 * Form submission handler for pizza_node_delete_confirm().
 */
function pizza_delete_confirm_submit($form, &$form_state) {
  if ($form_state['values']['nid']) {
    node_delete($form_state['values']['nid']);
    cache_clear_all();
    drupal_set_message(t('Node has been deleted successfully.'));
  }
}
